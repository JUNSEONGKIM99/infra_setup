# 전체 서비스 Reverse Proxy Nginx
# ---------------------------------------------------------------------------------

worker_processes  auto;

error_log  /etc/nginx/error.log warn;
pid        /etc/nginx/nginx.pid;

events {
    worker_connections  4096;
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /etc/nginx/access.log  main;
    sendfile        on;
    keepalive_timeout  65;
    resolver 127.0.0.11 valid=30s;  # Docker 내장 DNS 서버
    client_max_body_size 1000M;     # 1GB

    # springboot
    # -----------------------------------------------------------------------------
    upstream us_springboot{
        zone springboot_zone 64k;
        server springboot:8080 resolve;
    }

    server {
        listen 80;
        server_name www.*;
        server_name springboot.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name www.*;
        server_name springboot.*;
        include /etc/nginx/conf.d/https.conf;

        # # 프론트엔드 + 백엔드 통합 배포 시 사용 
        # location / {
        #     proxy_pass http://us_springboot;
        #     include /etc/nginx/conf.d/proxy.conf;
        # }

        # 분리 배포 방식     
        # # 백엔드: springboot로만 프록시
        location / {
            proxy_pass http://us_springboot/; # /api 경로는 백엔드로 프록시
            include /etc/nginx/conf.d/proxy.conf;
        }
        # # 프론트엔드: 정적 파일 직접 서빙 (/semes 경로 처리)
        location /semes/ {
            alias /usr/share/nginx/html/semes/;
            try_files $uri $uri/ /semes/index.html;
        }
        # 루트 경로를 /semes로 리다이렉트
        location = / {
            return 301 /semes/;
        }
    }

    # springboot_semes
    # -----------------------------------------------------------------------------
    upstream us_springboot_semes{
        zone springboot_semes_zone 64k;
        server semes:8082 resolve;
    }

    server {
        listen 80;
        server_name semes.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name semes.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_springboot_semes;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # dash
    # -----------------------------------------------------------------------------
    upstream us_dash{
        zone dash_zone 64k;
        server dash:8050 resolve;
    }

    server {
        listen 80;
        server_name dash.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name dash.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_dash;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }
    
    # fastapi
    # -----------------------------------------------------------------------------
    upstream us_fastapi {
        zone fastapi_zone 64k;
        server fastapi:8000 resolve;
    }
    

    server {
        listen 80;
        server_name api.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name api.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_fastapi;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # jupyterhub
    # -----------------------------------------------------------------------------
    upstream us_jupyterhub {
#        server host.docker.internal:8081;
        zone jupyterhub_zone 64k;
        server jupyterhub:8000 resolve;
    }

    server {
        listen 80;
        server_name jupyterhub.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name jupyterhub.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_jupyterhub;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # openldap
    # -----------------------------------------------------------------------------
    upstream us_openldap {
        zone openldap_zone 64k;
        server phpldapadmin:80 resolve;
    }

    server {
        listen 80;
        server_name openldap.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name openldap.*;
        include /etc/nginx/conf.d/https.conf;

        location / {
            proxy_pass http://us_openldap;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # keycloak
    # -----------------------------------------------------------------------------
    upstream us_keycloak {
        zone keycloak_zone 64k;
        server keycloak:8080 resolve;
    }

    server {
        listen 80;
        server_name keycloak.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name keycloak.*;
        include /etc/nginx/conf.d/https.conf;

        location / {
            proxy_pass http://us_keycloak;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # minio
    # -----------------------------------------------------------------------------
    upstream us_minio {
        zone minio_zone 64k;
        server minio:7077 resolve;
    }

    server {
        listen 80;
        server_name minio.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name minio.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_minio;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }
    
    # trino
    # -----------------------------------------------------------------------------
    upstream us_trino {
        zone trino_zone 64k;
        server trino:8080 resolve;
    }

    server {
        listen 80;
        server_name trino.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name trino.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_trino;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # spark
    # -----------------------------------------------------------------------------
    upstream us_spark {
        zone spark_zone 64k;
        server spark-master:8080 resolve;
    }

    server {
        listen 80;
        server_name spark.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name spark.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_spark;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # airflow
    # -----------------------------------------------------------------------------
    upstream us_airflow {
        zone airflow_zone 64k;
        server airflow-webserver:8080 resolve;
    }

    server {
        listen 80;
        server_name airflow.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name airflow.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_airflow;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # grafana
    # -----------------------------------------------------------------------------
    upstream us_grafana {
        zone grafana_zone 64k;
        server grafana:3000 resolve;
    }

    server {
        listen 80;
        server_name grafana.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name grafana.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_grafana;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # mlflow
    # -----------------------------------------------------------------------------
    upstream us_mlflow {
        zone mlflow_zone 64k;
        server mlflow:5000 resolve;
    }

    server {
        listen 80;
        server_name mlflow.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name mlflow.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_mlflow;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # sqlmesh
    # -----------------------------------------------------------------------------
    upstream us_sqlmesh {
        zone sqlmesh_zone 64k;
        server sqlmesh:8879 resolve;
    }

    server {
        listen 80;
        server_name sqlmesh.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name sqlmesh.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_sqlmesh;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # portainer
    # -----------------------------------------------------------------------------
    upstream us_portainer {
        zone portainer_zone 64k;
        server portainer:9000 resolve;
    }

    server {
        listen 80;
        server_name portainer.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name portainer.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_portainer;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # flink
    # -----------------------------------------------------------------------------
    upstream us_flink {
        zone flink_zone 64k;
        server flink-jm:8081 resolve;
    }

    server {
        listen 80;
        server_name flink.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name flink.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_flink;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # nexus
    # -----------------------------------------------------------------------------
    upstream us_nexus {
        zone nexus_zone 64k;
        server nexus:8081 resolve;
    }

    server {
        listen 80;
        server_name nexus.ai-biz.net;
        return 301 https://$host$request_uri;
    }

    server {
        server_name nexus.ai-biz.net;
        include /etc/nginx/conf.d/aibiz.https.conf;
        location / {
            proxy_pass http://us_nexus;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # gitlab
    # -----------------------------------------------------------------------------
    upstream us_gitlab {
        zone gitlab_zone 64k;
        server gitlab:80 resolve;
    }

    server {
        listen 80;
        server_name gitlab.ai-biz.net;
        return 301 https://$host$request_uri;
    }

    server {
        server_name gitlab.ai-biz.net;
        include /etc/nginx/conf.d/aibiz.https.conf;
        location / {
            proxy_pass http://us_gitlab;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # gitlab external
    # -----------------------------------------------------------------------------
    upstream us_gitlabex {
        zone gitlabex_zone 64k;
        server gitlabex:80 resolve;
    }

    server {
        listen 80;
        server_name gitlabex.ai-biz.net;
        #return 301 https://$host$request_uri;
        location / {
            proxy_pass http://us_gitlabex;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    server {
        server_name gitlabex.ai-biz.net;
        include /etc/nginx/conf.d/aibiz.https.conf;
        location / {
            proxy_pass http://us_gitlabex;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # sonarqube
    # -----------------------------------------------------------------------------
    upstream us_sonarqube {
        zone sonarqube_zone 64k;
        server sonarqube:9000 resolve;
    }

    server {
        listen 80;
        server_name sonarqube.ai-biz.net;
        return 301 https://$host$request_uri;
    }

    server {
        server_name sonarqube.ai-biz.net;
        include /etc/nginx/conf.d/aibiz.https.conf;
        location / {
            proxy_pass http://us_sonarqube;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    #  open-web ui
upstream us_openweb {
        zone openweb_zone 64k;
        server open-webui:8080 resolve;
    }

    server {
        listen 80;
        server_name llm.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name llm.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_openweb;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # drawio
    # -----------------------------------------------------------------------------
    upstream us_drawio {
        zone drawio_zone 64k;
        server drawio:8080 resolve;
    }

    server {
        listen 80;
        server_name drawio.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name drawio.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_drawio;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }

    # lightdash
    # -----------------------------------------------------------------------------
    upstream us_lightdash {
        zone lightdash_zone 64k;
        server lightdash:8080 resolve;
    }

    server {
        listen 80;
        server_name lightdash.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name lightdash.*;
        include /etc/nginx/conf.d/https.conf;
        location / {
            proxy_pass http://us_lightdash;
            include /etc/nginx/conf.d/proxy.conf;
        }
    }


    #vllm - test
    #---------------------------
    upstream us_qwen32b {
        zone vllm_zone_32b 64k;
        server vllm-qwen32b-24k:8000;
    }

    upstream us_gemma27b {
        zone vllm_zone_gemma 64k;
        server vllm-gemma27-vl:8000;
    }

    upstream us_qwen8b {
        zone vllm_zone_8b 64k;
        server vllm-qwen-8b-emb:8000;
    }

    server {
        listen 80;
        server_name vllm.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name vllm.*;
        include /etc/nginx/conf.d/https.conf;
        
        
        location /vllm-qwen32b/ {
            proxy_pass http://us_qwen32b/; 
            include /etc/nginx/conf.d/proxy.conf;
            }

    # --- Route 2: Gemma 27B VL ---
        location /vllm-gemma27b-vl/ {
            proxy_pass http://us_gemma27b/;
            include /etc/nginx/conf.d/proxy.conf;
            }

    # --- Route 3: Qwen 8B Embedding ---
        location /vllm-qwen-8b-emb/ {
            proxy_pass http://us_qwen8b/;
            include /etc/nginx/conf.d/proxy.conf;
            }
    # Option A: expose vLLM exactly as /v1/*
        # location /v1/ {
        #     proxy_pass http://us_vllm/v1/;
        #    include /etc/nginx/conf.d/proxy.conf;

        #     strongly recommended for streaming responses
        #                proxy_buffering off;
        #     proxy_read_timeout 3600;
        # }

    # Optional: simple health check
        location /health {
            return 200 "ok\n";
        }
    }
    


    # nextcloud
    # -----------------------------------------------------------------------------
    upstream us_nextcloud {
        zone nextcloud_zone 64k;
        server nextcloud:9980 resolve;
    }

    server {
        listen 80;
        server_name nextcloud.*;
        return 301 https://$host$request_uri;
    }

    server {
        server_name nextcloud.*;
        include /etc/nginx/conf.d/https.conf;
        #ssl_ciphers HIGH:!aNULL:!MD5;

        # Security Headers
        #add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";
        #add_header X-Content-Type-Options nosniff;
        #add_header X-Frame-Options DENY;
        #add_header X-XSS-Protection "1; mode=block";

        # Access and error logs
        #error_log /var/log/nginx/nextcloud_collabora_error.log;
        #access_log /var/log/nginx/nextcloud_collabora_access.log;

        # Nextcloud reverse proxy
        location / {
            proxy_pass http://us_nextcloud;
            include /etc/nginx/conf.d/proxy.conf;
        }
        
        # Collabora Online reverse proxy (using upstream us_nextcloud)
        location /browser {
            proxy_pass http://us_nextcloud/browser;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /hosting/discovery {
            proxy_pass http://us_nextcloud/hosting/discovery;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /hosting/capabilities {
            proxy_pass http://us_nextcloud/hosting/capabilities;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location ~ ^/cool/(.*)/ws$ {
            proxy_pass http://us_nextcloud/cool/$1/ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /cool/adminws {
            proxy_pass http://us_nextcloud/cool/adminws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /cool {
            proxy_pass http://us_nextcloud/cool;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /lool {
            proxy_pass http://us_nextcloud/cool;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }
    }
}
